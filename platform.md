# Platform Interface Specification

This document specifies the interface between a lifecycle and a platform.

A platform orchestrates a lifecycle to make buildpack functionality available to end-users such as application developers.

Examples of a platform might include:

1. A local CLI tool that uses buildpacks to create OCI images
1. A plugin for a continuous integration service that uses buildpacks to create OCI images
1. A cloud application platform that uses buildpacks to build source code before deployment

## Table of Contents
<!-- Using https://github.com/yzhang-gh/vscode-markdown to manage toc -->
- [Platform Interface Specification](#platform-interface-specification)
  - [Table of Contents](#table-of-contents)
  - [Platform API Version](#platform-api-version)
  - [Terminology](#terminology)
  - [Stacks](#stacks)
    - [Compatibility Guarantees](#compatibility-guarantees)
    - [Build Image](#build-image)
    - [Run Image](#run-image)
    - [Mixins](#mixins)
  - [Lifecycle Interface](#lifecycle-interface)
    - [Platform API Compatibility](#platform-api-compatibility)
    - [Operations](#operations)
      - [Build](#build)
      - [Rebase](#rebase)
      - [Launch](#launch)
    - [Usage](#usage)
      - [`detector`](#detector)
      - [`analyzer`](#analyzer)
        - [Layer analysis](#layer-analysis)
      - [`restorer`](#restorer)
        - [Layer restoration](#layer-restoration)
      - [`builder`](#builder)
      - [`exporter`](#exporter)
      - [`creator`](#creator)
      - [`rebaser`](#rebaser)
      - [`launcher`](#launcher)
  - [Buildpacks](#buildpacks)
    - [Buildpacks Directory Layout](#buildpacks-directory-layout)
  - [Security Considerations](#security-considerations)
  - [Additional Guidance](#additional-guidance)
    - [Environment](#environment)
    - [Caching](#caching)
  - [Data Format](#data-format)
    - [Files](#files)
      - [`analyzed.toml` (TOML)](#analyzedtoml-toml)
      - [`group.toml` (TOML)](#grouptoml-toml)
      - [`metadata.toml` (TOML)](#metadatatoml-toml)
      - [`order.toml` (TOML)](#ordertoml-toml)
      - [`project-metadata.toml` (TOML)](#project-metadatatoml-toml)
      - [`stack.toml` (TOML)](#stacktoml-toml)
    - [Labels](#labels)
      - [`io.buildpacks.build.metadata` (JSON)](#iobuildpacksbuildmetadata-json)
      - [`io.buildpacks.lifecycle.metadata` (JSON)](#iobuildpackslifecyclemetadata-json)
      - [`io.buildpacks.project.metadata` (JSON)](#iobuildpacksprojectmetadata-json)


## Platform API Version

**Current Version**: 0.3

The Platform API version:
 - MUST be in form `<major>.<minor>` or `<major>`, where `<major>` is equivalent to `<major>.0`
 - When `<major>` is greater than `0` increments to `<minor>` SHALL exclusively indicate additive changes

## Terminology

A **stack** is a contract defined by a base run OCI image and a base build OCI image that are only updated with security patches.
Stack images can be modified with mixins in order to make additive changes to the contract.

A **mixin** is a named set of additions to a stack that avoid changing the behavior of buildpacks or apps that do not depend on the mixin.

An **app image** refers to an OCI image generated by the lifecycle by extending the run image with any or all of the following: app layers, launch layers, launcher layers, image configuration

A **launch layer** refers to a layer in the app image created from a  `<layers>/<layer>` directory as specified in the [Buildpack Interface Specification](buildpack.md).

An **app layer** refers to a layer in the app image created from the `<app>` directory as specified in the [Buildpack Interface Specification](buildpack.md).

A **launcher layer** refers to a layer in the app OCI image containing the launcher itself and/or launcher configuration

The **launcher** refers to a lifecycle binary packaged in the app image for the purpose of executing processes at runtime

## Stacks
### Compatibility Guarantees

Stack image authors SHOULD ensure that build image versions maintain [ABI-compatibility](https://en.wikipedia.org/wiki/Application_binary_interface) with previous versions, although violating this requirement will not change the behavior of previously built images containing app and launch layers.

Stack image authors MUST ensure that new run image versions maintain [ABI-compatibility](https://en.wikipedia.org/wiki/Application_binary_interface) with previous versions.
Stack image authors MUST ensure that app and launch layers do not change behavior when the run image layers are upgraded to newer versions, unless those behavior changes are intended to fix security vulnerabilities.

Mixin authors MUST ensure that mixins do not affect the [ABI-compatibility](https://en.wikipedia.org/wiki/Application_binary_interface) of any object code compiled to run on the base stack images without mixins.

During build, platforms MUST use the same set of mixins for the run image as were used in the build image (excluding mixins that have a stage specifier).

### Build Image

The platform MUST ensure that:

- The image config's `User` field is set to a non-root user with a writable home directory.
- The image config's `Env` field has the environment variable `CNB_STACK_ID` set to the stack ID.
- The image config's `Env` field has the environment variable `CNB_USER_ID` set to the UID of the user specified in the `User` field.
- The image config's `Env` field has the environment variable `CNB_GROUP_ID` set to the primary GID of the user specified in the `User` field.
- The image config's `Label` field has the label `io.buildpacks.stack.id` set to the stack ID.
- The image config's `Label` field has the label `io.buildpacks.stack.mixins` set to a JSON array containing mixin names for each mixin applied to the image.

### Run Image

The platform MUST ensure that:

- The image config's `User` field is set to a user with the same UID and primary GID as in the build image.
- The image config's `Label` field has the label `io.buildpacks.stack.id` set to the stack ID.
- The image config's `Label` field has the label `io.buildpacks.stack.mixins` set to a JSON array containing mixin names for each mixin applied to the image.

### Mixins

A mixin name MUST only be defined by the author of its corresponding stack.
A mixin name MUST always be used to specify the same set of changes.
A mixin name MUST only contain a `:` character as part of an optional stage specifier.

A mixin prefixed with the `build:` stage specifier only affects the build image and does not need to be specified on the run image.
A mixin prefixed with the `run:` stage specifier only affects the run image and does not need to be specified on the build image.

A platform MAY support any number of mixins for a given stack in order to support application code or buildpacks that require those mixins.

Changes introduced by mixins SHOULD be restricted to the addition of operating system software packages that are regularly patched with strictly backwards-compatible security fixes.
However, mixins MAY consist of any changes that follow the [Compatibility Guarantees](#compatibility-guarantees).

## Lifecycle Interface
### Platform API Compatibility

The platform SHOULD set `CNB_PLATFORM_API=<major>[.<minor>]` in the lifecycle's execution environment

IF `CNB_PLATFORM_API=<major>[.<minor>]` is set in the lifecycle's execution environment, the lifecycle MUST do one the following before attempting to parse other inputs
  - Conform usage and behavior to the given version of the platform API specification
  - Fail if it does not support the requested API version

### Operations

#### Build
A single app image build consists of the following phases:

1. Detection
1. Analysis
1. Cache Restoration
1. Build
1. Export

A platform MUST execute these phases EITHER by invoking the following phase-specific lifecycle binaries in order:
1. `/cnb/lifecycle/detector`
1. `/cnb/lifecycle/analyzer`
1. `/cnb/lifecycle/restorer`
1. `/cnb/lifecycle/builder`
1. `/cnb/lifecycle/exporter`

OR by executing `/cnb/lifecycle/creator`.

#### Rebase
Run image rebasing allows for fast stack updates for already-exported OCI images without requiring a rebuild. A rebase requires minimal data transfer when those images are stored on a Docker registry.
When a new stack version with the same stack ID is available, the app layers and launch layers SHOULD be rebased on the new run image by updating the image's configuration to point at the new run image.

To rebase an app image a platform MUST execute the `/cnb/lifecycle/rebaser` OR perform an equivalent operation.
 
#### Launch
`/cnb/lifecycle/launcher` is responsible for launching user and buildpack provided processes in the correct execution environment.
`/cnb/lifecycle/launcher` SHALL be the `ENTRYPOINT` for all app images.

### Usage

The following is true of all lifecycle phases:

- Command line inputs ALWAYS take precedence over other inputs
- IF `CNB_PLATFORM_API=<major>[.<minor]` is set in the lifecycle's execution environment, the lifecycle MUST do one the following before attempting to parse other inputs
    - Conform behavior to the given version of the platform API specification
    - Fail if it does not support the requested API version

#### `detector`
The platform MUST execute `detector` in the build environment

Usage: 
```
/cnb/lifecycle/detector \
  [-app <app>] \
  [-buildpacks <buildpacks>] \
  [-group <group>] \
  [-log-level <log-level>] \
  [-order <order>] \
  [-plan <plan>] \
  [-platform <platform>]
```

| Input         | Environment Variable| Default Value   | Description
|---------------|---------------------|-----------------|----------------------
| `<app>`         | `CNB_APP_DIR`         | `/workspace`      | Path to application directory
| `<buildpacks>`  | `CNB_BUILDPACKS_DIR`  | `/cnb/buildpacks` | Path to buildpacks directory (see [Buildpacks Directory Layout](#buildpacks-directory-layout))
| `<group>`       | `CNB_GROUP_PATH`      | `./group.toml`    | Path to output group file
| `<log-level>`   | `CNB_LOG_LEVEL`       | `info`            | Log Level
| `<order>`       | `CNB_ORDER_PATH`      | `./order.toml`    | Path to order definition (see [`order.toml` (TOML)](#order.toml-(toml)))
| `<plan>`        | `CNB_PLAN_PATH`       | `./plan.toml`     | Path to output build plan file
| `<platform>`    | `CNB_PLATFORM_DIR`    | `/platform`       | Path to platform directory

| Output             | Description
|--------------------|----------------------------------------------
| [exit status]      | Success (0), or error (1+)
| `/dev/stdout`      | Logs (info)
| `/dev/stderr`      | Logs (warnings, errors)
| `<group>`          | Detected buildpack group  (see [`group.toml` (TOML)](#group.toml-(toml)))
| `<plan>`           | Resolved Build Plan (see  data format in [Buildpack Interface Specification](buildpack.md))

#### `analyzer`
Usage: 
```
/cnb/lifecycle/analyzer <image> \
  [-analyzed <analyzed>] \
  [-cache-dir <cache-dir>] \
  [-cache-image <cache-image>] \
  [-daemon] \ # sets <daemon>
  [-gid <gid>] \
  [-group <group>] \
  [-layers <layers>] \
  [-skip-layers <skip-layers>] \
  [-uid <uid>] \
```

| Input          | Environment Variable  | Default Value     | Description
|----------------|-----------------------|-------------------|----------------------
| `<analyzed>`   | `CNB_ANALYZED_PATH`   | `./analyzed.toml` | Path to output analysis metadata (see [`analyzed.toml` (TOML)](#analyzed.toml-(toml))
| `<cache-dir>`  | `CNB_CACHE_DIR`       |                   | Location of cache, provided as a directory
| `<cache-image>`| `CNB_CACHE_IMAGE`     |                   | Location of cache, provided as an image
| `<gid>`        | `CNB_GROUP_ID`        |                   | Group of user that build phase will run as
| `<group>`      | `CNB_GROUP_PATH`      | `./group.toml`    | Path to group definition (see [`group.toml` (TOML)](#group.toml-(toml)))
| `<image>`      |                       |                   | Image reference to be analyzed (usually the result of the previous build)
| `<layers>`     | `CNB_LAYERS_DIR`      | `/layers`         | Path to layer directory
| `<skip-layers>`| `CNB_SKIP_LAYERS`     | `false`           | Do not write layer metadata
| `<uid>`        | `CNB_USER_ID`         |                   | User that build phase will run as
| `<use-daemon>` | `CNB_USE_DAEMON`      | `false`           | Analyze image from docker daemon

- IF `<use-daemon>` is `false`, `<image>` MUST be a valid registry reference
- IF `<use-daemon>` is `true`, `<image>` MUST be a valid registry reference OR a docker image ID
- The lifecycle MUST accept valid references to non-existent images without error.

| Output             | Description
|--------------------|----------------------------------------------
| [exit status]      | Success (0), or error (1+)
| `/dev/stdout`      | Logs (info)
| `/dev/stderr`      | Logs (warnings, errors)
| `<analyzed>`       | Analysis metadata (see [`analyzed.toml` (TOML)](#analyzed.toml-(toml))
| `<layers>/<buidpack-id>/<layer>.toml` files          | Contain analyzed layer metadata (see  data format in [Buildpack Interface Specification](buildpack.md))
| `<layers>/<buidpack-id>/<layer>.sha` files           | Contain sha256 of the uncompressed layer

- The lifecycle MUST write analysis metadata if `<image>` is accessible.
- IF `<skip-layers>` is `false` the lifecycle MUST analyze layers created by any buildpack present in the provided `<group>`.
- IF `<skip-layers>` is `true` the lifecycle MUST NOT analyze layers.

##### Layer analysis
When analyzing a given layer the lifecycle SHALL:
- IF `build=true`, `cache=false`:
    - Do nothing
- ELSE IF `launch=true`:
    - Write layer metadata read from the analyzed image to `<layers>/<buildpack-id>/<layer-name>.toml`
    - Write the sha256 of the uncompressed layer from the analyzed image to `<layers>/<buildpack-id>/<layer-name>.sha`
- ELSE IF `cache=true`:
    - Write layer metadata read from the cache to `<layers>/<buildpack-id>/<layer-name>.toml`
    - Write the sha256 of the uncompressed layer from the cache to `<layers>/<buildpack-id>/<layer-name>.sha`

#### `restorer`
Usage:
```
/cnb/lifecycle/restorer \
  [-cache-dir <cache-dir>]
  [-cache-image <cache-image>]
  [-gid <gid>] \
  [-group <group>] \
  [-layers <layers>] \
  [-uid <uid>]
```

| Input          | Environment Variable  | Default Value   | Description
|----------------|-----------------------|-----------------|----------------------
| `<cache-dir>`  | `CNB_CACHE_DIR`       |                 | Path to a cache directory
| `<cache-image>`| `CNB_CACHE_IMAGE`     |                 | Reference to a cache image in an OCI image registry
| `<gid>`        | `CNB_GROUP_ID`        |                 | Group of user that build phase will run as
| `<group>`      | `CNB_GROUP_PATH`      | `./group.toml`  | Path to group definition (see [`group.toml` (TOML)](#group.toml-(toml)))
| `<layers>`     | `CNB_LAYERS_DIR`      | `/layers`       | Path to layer directory
| `<uid>`        | `CNB_USER_ID`         |                 | User that build phase will run as
| `<layers>/<buidpack-id>/<layer>.sha`  ||                 | Files Containing the sha256 of the uncompressed layers
| `<layers>/<buidpack-id>/<layer>.toml` ||                 | Files Containing analyzed layer metadata (see  data format in [Buildpack Interface Specification](buildpack.md))

| Output                             | Description
|------------------------------------|----------------------------------------------
| [exit status]                      | Success (0), or error (1+)
| `/dev/stdout`                      | Logs (info)
| `/dev/stderr`                      | Logs (warnings, errors)
| `<layers>/<buidpack-id>/<layer>/*` | Restored layer contents

##### Layer restoration
For each layer metadata file found in the `<layers>` directory the lifecycle:
- MUST restore cached layer contents IF the cache contains a layer with a matching ID
- MUST remove layer metadata IF `cache=true` AND the cache DOES NOT contain a matching layer

#### `builder`
The platform MUST execute `builder` in the build environment

Usage: 
```
/cnb/lifecycle/builder \
  [-app <app>] \
  [-buildpacks <buildpacks>] \
  [-group <group>] \
  [-layers <layers>] \
  [-plan <plan>] \
  [-platform <platform>]
```

| Input        | Env                 | Default Value   | Description
|--------------|---------------------|-----------------|----------------------
| `<app>`        | `CNB_APP_DIR`         | `/workspace`      | Path to application directory
| `<buildpacks>` | `CNB_BUILDPACKS_DIR`  | `/cnb/buildpacks` | Path to buildpacks directory (see [Buildpacks Directory Layout](#buildpacks-directory-layout))
| `<group>`      | `CNB_GROUP_PATH`      | `./group.toml`    | Path to group file (see [`group.toml` (TOML)](#group.toml-(toml)))
| `<layers>`     | `CNB_LAYERS_DIR`      | `/layers`         | Path to layer directory
| `<plan>`       | `CNB_PLAN_PATH`       | `./plan.toml`     | Path to output build plan file (see  data format in [Buildpack Interface Specification](buildpack.md))
| `<platform>`   | `CNB_PLATFORM_DIR`    | `/platform`       | Path to platform directory

| Output                                     | Description
|--------------------------------------------|----------------------------------------------
| [exit status]                              | Success (0), or error (1+)
| `/dev/stdout`                              | Logs (info)
| `/dev/stderr`                              | Logs (warnings, errors)
| `<layers>/<buildpack ID>/<layer>`          | Layer contents buildpacks (see [Buildpack Interface Specfication](buildpack.md)
| `<layers>/<buildpack ID>/<layer>.toml`     | Layer metadata (see [Buildpack Interface Specfication](buildpack.md)
| `<layers>/config/metadata.toml`            | Build metadata (see [`metadata.toml` (TOML)](#metdata.toml-(toml))

- The lifecycle SHALL execute all buildpacks in the order defined in `<group>` according to the rules of the [Buildpack Interface Specification](buildpack.md).
- The lifecycle SHALL add all invoked buildpacks to `[[buildpacks]]` in `<layers>/config/metadata.toml`.
- The lifecycle SHALL aggregate all `processes`, `slices` and BOM entries returned by buildpacks in `<layers>/config/metadata.toml`.

#### `exporter`
Usage:
```
/cnb/lifecycle/exporter <image> [<image>...]
  [-analyzed <analyzed>] \
  [-app <app>] \
  [-cache-dir <cache-dir>] \
  [-cache-image <cache-image>] \
  [-daemon] \ # sets <daemon>
  [-gid <gid>] \
  [-group <group>] \
  [-launch-cache <launch-cache> ] \
  [-launcher <launcher> ] \
  [-layers <layers>] \
  [-log-level <log-level>] \
  [-process-type <process-type> ] \
  [-project-metadata <project-metadata> ] \
  [-run-image <run-image> | -image <run-image> ] \ # -image is Deprecated
  [-stack <stack>] \
  [-uid <uid> ]
```

| Input               | Environment Variable  | Default Value       | Description
|---------------------|-----------------------|---------------------|---------------------------------------
| `<analyzed>`        | `CNB_ANALYZED_PATH`   | `./analyzed.toml`   | Path to analysis metadata (see [`analyzed.toml` (TOML)](#analyzed.toml-(toml))
| `<app>`             | `CNB_APP_DIR`         | `/workspace`        | Path to application directory
| `<cache-dir>`       | `CNB_CACHE_DIR`       |                     | Path to a cache directory
| `<cache-image>`     | `CNB_CACHE_IMAGE`     |                     | Reference to a cache image in an OCI image registry
| `<daemon>`          | `CNB_USE_DAEMON`      | `false`             | Export image to docker daemon
| `<gid>`             | `CNB_GROUP_ID`        |                     | Group of user that build phase will run as
| `<group>`           | `CNB_GROUP_PATH`      | `./group.toml`      | Path to group file (see [`group.toml` (TOML)](#group.toml-(toml)))
| `<image>`           |                       |                     | An 
| `<launch-cache>`    | `CNB_LAUNCH_CACHE_DIR`|                     | Path to a cache directory containing launch layers
| `<launcher>`        |                       | `/cnb/lifecycle/launcher` | Path to the `launcher` executable
| `<layers>`          | `CNB_LAYERS_DIR`      | `/layers`           | Path to layer directory
| `<log-level>`       | `CNB_LOG_LEVEL`   `   | `info`                | Log Level
| `<process-type>`    | `CNB_PROCESS_TYPE`    |                     | Default process type to set in the exported image
| `<project-metadata>`| `CNB_PROCESS_TYPE`    | `./project-metadata.toml` | Path to a project metadata file (see [`project-metadata.toml` (TOML)](#project-metadata.toml)
| `<run-image>`       | `CNB_RUN_IMAGE`       | derived from `<stack>` | Run image reference
| `<stack>`           | `CNB_STACK_PATH`      | `/cnb/stack.toml`   | Path to stack file (see [`stack.toml` (TOML)](#stack.toml-(toml))
| `<uid>`             | `CNB_USER_ID`         |                     | User that build phase will run as
| `<layers>/config/metadata.toml` | | | Build metadata (see [`metadata.toml` (TOML)](#metdata.toml-(toml))

- At least one `<image>` must be provided
- Each `<image>` MUST be a valid OCI image registry tag reference
- IF `<use-daemon>` is `false` and more than one `<image>` is provided they MUST refer to the same registry
- IF `<run-image>` is not provided by the platform the value will be derived from the contents of `stack`
    - IF any of `run-image.image` or `run-image.mirrors` has a registry matching that of `<image>`, this value will become the `<run-image>`
    - IF none of `run-image.image` or `run-image.mirrors` has a registry matching that of `<image>`, `<run-image.image>` will become the `<run-image>`

| Output             | Description
|--------------------|----------------------------------------------
| `[exit status]`     | Success (0), or error (1+)
| `/dev/stdout`      | Logs (info)
| `/dev/stderr`      | Logs (warnings, errors)
| `<image>`           | Exported app image (see [Buildpack Interface Specfication](buildpack.md)

- The lifecycle SHALL write the same app image to each `<image>` tag
- The app image:
    - MUST be an extension of the `<run-image>`
      - All run-image layers and config values SHALL be preserved unless they conflict with the following
    - MUST contain all buildpack provided launch layers as determined by the [Buildpack Interface Specfication](buildpack.md)
    - MUST contain one or more app layers as determined by the [Buildpack Interface Specfication](buildpack.md)
    - MUST contain a layer that includes the `<launcher>`
    - MUST contain a layer that includes `<layers>/config/metadata.toml`
    - MUST have `ENTRYPOINT=<launcher>`
    - MUST contain the following `Env` entries
      - `"CNB_LAYERS_DIR=<layers>"`
      - `"CNB_APP_DIR=<app>"`
    - MUST contain the following `Env` entry, IF `<process-type>` is set
      - `"CNB_PROCESS_TYPE=<process-type>"`
    - MUST contain the following labels
        - `io.buildpacks.lifecycle.metadata`: see [lifecycle metadata label (JSON)](#lifecycle-metadata-label-(json))
        - `io.buildpacks.project.metadata`: the value of which SHALL be the json representation `<project-metadata>`
        - `io.buildpacks.build.metadata`: see [build metadata (JSON)](#build-metadata-label-(json))

IF a cache is provided the lifecycle SHALL:
- Write `io.buildpacks.cache.metadata` to the cache
- Ensure all `cache=true` layers are written to the cache

#### `creator`
Usage:
```
/cnb/lifecycle/creator <image>
  [-app <app>] \
  [-cache-dir <cache-dir>] \
  [-cache-image <cache-image>] \
  [-daemon] \ # sets <daemon>
  [-gid <gid>] \
  [-launch-cache <launch-cache> ] \
  [-launcher <launcher> ] \
  [-layers <layers>] \
  [-log-level <log-level>] \
  [-order <order>] \
  [-platform <platform>] \
  [-previous-image <previous-image> ] \
  [-process-type <process-type> ] \
  [-project-metadata <project-metadata> ] \
  [-run-image <run-image>] \
  [-skip-restore <skip-restore>] \
  [-stack <stack>] \
  [-tag <tag>...] \
  [-uid <uid> ]
```

Running `creator` SHALL be equivalent to running `detector`, `analzyer`, `restorer`, `builder` and `exporter` in order with identical inputs where they are accepted, with the following exceptions.

| Input             | Environment Variable| Default Value| Description
|-------------------|---------------------|--------------|----------------------
| `<previous-image>`| `CNB_PREVIOUS_IMAGE`| `<image>`    | Image reference to be analyzed (usually the result of the previous build)
| `<skip-restore>`  | `CNB_SKIP_RESTORE`  | `false`      | Do not write layer metadata or restore cached layers
| `<tag>...`        |                     |              | Additional tag to apply to exported image

- IF `<skip-restore>` is `true` the `creator` SHALL skip layer analysis and skip the entire Restore phase.
- IF the platform provides one or more `<tag>` inputs they SHALL be treated as additional `<image>` inputs to the `exporter`

Outputs produced by `creator` and identical to those produced by `exporter`.

#### `rebaser`
Usage:
```
/cnb/lifecycle/rebaser <image> [<image>...] \
  [-daemon] \ # sets <daemon>
  [-gid <gid>] \
  [-log-level <log-level>] \
  [-run-image <run-image> | -image <run-image> ] \ # -image is Deprecated
  [-uid <uid>]
```

| Input               | Environment Variable  | Default Value         | Description
|---------------------|-----------------------|-----------------------|---------------------------------------
| `<daemon>`          | `CNB_USE_DAEMON`      | `false`               | Export image to docker daemon
| `<gid>`             | `CNB_GROUP_ID`        |                       | Group of user that build phase will run as
| `<image>`           |                       |                       | App image to rebase
| `<log-level>`       | `CNB_LOG_LEVEL`       | `info`                  | Log Level
| `<run-image>`       | `CNB_RUN_IMAGE`       | derived from `<image>` | Run image reference
| `<uid>`             | `CNB_USER_ID`         |                       | User that build phase will run as

- At least one `<image>` must be provided
- Each `<image>` MUST be a valid OCI image registry tag reference
- IF `<use-daemon>` is `false` and more than one `<image>` is provided they MUST refer to the same registry
- IF `<run-image>` is not provided by the platform the value will be derived from the contents of the `stack` key in the `io.buildpacks.lifecycle.metdata` label on `<image>`
    - IF any of `run-image.image` or `run-image.mirrors` has a registry matching that of `<image>`, this value will become the `<run-image>`
    - IF none of `run-image.image` or `run-image.mirrors` has a registry matching that of `<image>`, `<run-image.image>` will become the `<run-image>`

| Output             | Description
|--------------------|----------------------------------------------
| [exit status]      | Pass (0), or error (1+)
| `/dev/stdout`      | Logs (info)
| `/dev/stderr`      | Logs (warnings, errors)
| `<image>`          | Rebased app image (see [Buildpack Interface Specfication](buildpack.md)

- The lifecycle SHALL write the same app image to each `<image>` tag
- The rebased app image SHALL be identical to `<image>`, with the following modifications:
    - Run image layers SHALL be defined as Layers in `<image>` up to and including the layer with diff ID matching the value of `run-image.top-layer` from the `io.buildpacks.lifecycle.metadata` label
    - Run image layers SHALL be replaced with the layers from the new `<run-image>`
    - The value of `io.buildpacks.lifecycle.metadata` SHALL be modified as follows
      - `run-image.reference` SHALL uniquely identify `<run-image>`
      - `run-image.top-layer` SHALL be set to the uncompressed digest of the top layer in `<run-image>`

#### `launcher`
Usage:
```
/cnb/lifecycle/launcher [--] [<cmd> <arg>...]
```

| Input               | Environment Variable  | Default Value         | Description
|---------------------|-----------------------|-----------------------|---------------------------------------
| `<app>`             | `CNB_APP_DIR`         | `/workspace`          | Path to application directory
| `<layers>`          | `CNB_LAYERS_DIR`      | `/layers`             | Path to layer directory
| `<process-type>`    | `CNB_PROCESS_TYPE`    | `web`                 | `type` of process to launch
| `<direct>`          |                       | `false`               | Execution strategy for user provided process
| `<cmd>`             |                       |                       | User-provided command
| `<arg>...`          |                       |                       | Arguments to user-provided command
| `<layers>/config/metadata.toml`    |        | | Build metadata (see [`metadata.toml` (TOML)](#metdata.toml-(toml))
| `<layers>/<buildpack-id>/<layer>/` |        | | Launch Layers

- IF `$1` is `--` `<direct>` is `true` and `<args>` SHALL be `${@2:}`
- IF `$1` is anything other than `--`, `<direct>` is `false`, and `<args>` SHALL be `$@`
- IF `<direct>`
- IF `<args>` are NOT provided `launcher` SHALL select the process with `type` equal to `<process-type>` from `<layers>/config/metadata.toml` and launch it as described in the [Buildpack Interface Specification](buildpack.md).
- IF `<args>` are provided `launcher` SHALL behaves as if it selected a process with the following process from `metadata.toml`.
```
[[process]]
direct = <direct>
command = "<cmd>"
args = ["<arg>"...]
```

- The lifecycle SHOULD replace the lifecycle process in memory without forking it.
- The process execution environment SHALL be identical to the lifecycle execution environment, with the following exceptions:
    - `CNB_APP_DIR` SHALL NOT be set in the process environment
    - `CNB_LAYERS_DIR` SHALL NOT be set in the process environment
    - `CNB_PROCESS_TYPE` SHALL NOT be set in the process environment

## Buildpacks

### Buildpacks Directory Layout

The buildpacks directory MUST contain unarchived buildpacks such that:

- Each top-level directory is a buildpack ID.
- Each second-level directory is a buildpack version.

## Security Considerations

The platform SHOULD run each phase of the lifecycle in an isolated container to prevent untrusted app and buildpack code from accessing storage credentials needed during the export and analysis phases.
A more thorough explanation is provided in the [Buildpack Interface Specification](buildpack.md).

## Additional Guidance

### Environment

The platform MAY determine the initial environment of the build phase, detection phase, and launch.
The lifecycle MUST NOT assume that all platforms provide an identical environment.

### Caching

IF caching is enabled the platform is responsible for providing the lifecycle with access to the correct cache.
Whenever possible, the platform SHOULD provide the same cache to each rebuild of a given app image.
Cache locality and availability MAY vary between platforms.

## Data Format

### Files

#### `analyzed.toml` (TOML)

```toml
[image]
  reference = "<image reference>"

[metadata]
# layer metadata
```

Where:
- `image.reference` MUST be EITHER a digest reference to an image in a docker registry or the ID of an image in a docker daemon
- `metadata` MUST be the TOML representation of the layer [metadata label](#layer-metadata-label-json)

#### `group.toml` (TOML)

```toml
group = [
  { id = "<buildpack ID>", version = "<buildpack version>" }
]
```

Where:

- Both `id` and `version` MUST be present for each buildpack object in a group.

#### `metadata.toml` (TOML)
```toml
[[buildpacks]]
id = "<buildpack ID>"
version = "<buildpack Version>"
optional = false

[[processes]]
type = "<process type>"
command = "<command>"
args = ["<arguments>"]
direct = false

[[slices]]
paths = ["<app sub-path glob>"]

[bom]
```

Where:
- Both `id` and `version` MUST be present for each buildpack.
- Where `processes` contains the complete set of processes contributed by all buildpacks
- Where `processes` contains the complete set of slice defined by all buildpacks
- Where `bom` contains the Bill of Materials

#### `order.toml` (TOML)

```toml
[[order]]
[[order.group]]
id = "<buildpack ID>"
version = "<buildpack version>"
optional = false
```

Where:

- Both `id` and `version` MUST be present for each buildpack object in a group.
- The value of `optional` MUST default to false if not specified.

#### `project-metadata.toml` (TOML)

```toml
[source]
type = "<source type>"

[source.version]
# arbitrary data

[source.metadata]
# arbitrary data
```

Where:
- All values are optional
- `type`, if present, SHOULD contain the type of location where the provided app source is stored (e.g `git`, `s3`)
- `version`, if present, SHOULD contain data uniquely identifying the particular version of the provided source
- `metadata` MAY contain additional arbitrary data about the provided source

#### `stack.toml` (TOML)

```toml
[run-image]
 image = "<image>"
 mirrors = ["<mirror>", "<mirror>"]
```

Where:
- `run-image.image` MAY be a reference to a run image in a docker registry
- `run-image.mirrors` MUST NOT be present IF `run-image.image` is not present
- `run-image.mirrors` MAY contain one or more tag references to run images in docker registries
- All `run-image.mirrors`:
  - SHOULD reference an image with ID identical to that of `run-image.image`
- `run-image.image` and `run-image.mirrors.[]` SHOULD each refer to a unique registry

### Labels

#### `io.buildpacks.build.metadata` (JSON)

```json
{
  "processes": [
    {
      "type": "<process-type>",
      "command": "<command>",
      "args": [
        "<args>"
      ],
      "direct": false
    }
  ],
  "buildpacks": [
    {
      "id": "<buildpack ID>",
      "version": "<buildpack Version>"
    }
  ],
  "bom": [
    {
      "name": "<bom-entry-name>",
      "version": "<bom-entry-version>",
      "metadata": {
        # arbitrary buildpack provided metadata
      },
      "buildpack": {
        "id": "<buildpack ID>",
        "version": "<buildpack Version>"
      }
    },
  ],
 "launcher": {
    "version": "<launcher-version>",
    "source": {
      "git": {
        "repository": "<launcher-source-repository>",
        "commit": "<launcher-source-commit>"
      }
    }
  }
}
```
Where:
- `processes` MUST contain all buildpack contributed processes
- `buildpacks` MUST contain the detected group
- `bom` MUST contain the Bill of Materials
- `launcher.version` SHOULD contain the version of the `launcher` binary included in the app
- `luancher.source.git.repository` SHOULD contain the git repository containing the `launcher` source code
- `luancher.source.git.commit` SHOULD contain the git commit from which the given `launcher` was built

#### `io.buildpacks.lifecycle.metadata` (JSON)

```json
{
  "app": [
    {"sha": "<slice-layer-diffID>"}
  ],
  "config": {
    "sha": "<config-layer-diffID>"
  },
  "launcher": {
    "sha": "<launcher-layer-diffID>"
  },
  "buildpacks": [
    {
      "key": "<buldpack-id>",
      "version": "<buildpack-version>",
      "layers": {
        "<layer-name>": {
          "sha": "<layer-diffID>",
          "data": {},
          "build": false,
          "launch": false,
          "cache": false
        }
      }
    }
  ],
  "runImage": {
    "topLayer": "<run-image-top-layer-diffID>",
    "reference": "<run-image-reference>"
  },
  "stack": {
    "runImage": {
      "image": "cnbs/sample-stack-run:bionic"
    }
  }
}
```
Where:
- `app` MUST contain one entry per app slice layer where
  - `sha` MUST contain the digest of the uncompressed layer
- `config.sha` MUST the digest of the uncompressed layer containing launcher config
- `launcher.sha` MUST the digest of the uncompressed layer containing the launcher binary
- `buildpacks` MUST contain one entry per buildpack that participated in the build where
  - `key` is required and MUST contain the buildpack ID
  - `version` is required and MUST contain the buidpack Version
  - `layers` is required and MUST contain one entry per launch layer contributed by the given buildpack.
  - For each entry in `layers`:
    - The key  MUST be the name of the layer
    - The value MUST contain JSON representation of the `layer.toml` with an additional `sha` key, containing the digest of the uncompressed layer
    - The value MUST contain an additional `sha` key, containing the digest of the uncompressed layer
- `run-image.topLayer` must contain the uncompressed digest of the top layer of the run-image
- `run-image.reference` MUST uniquely identify the run image. It MAY contain one of the following
  - An image ID (the digest of the uncompressed config blob)
  - A digest reference to a manifest stored in an OCI image registry
- `stack` MUST contain the json representation of `stack.toml`

#### `io.buildpacks.project.metadata` (JSON)

```json
{
  "source": {
    "type": "<type",
    "version": {
     # arbitrary version data
    },
    "metadata": {
    # arbitrary data
    }
  }
}
```
This label MUST contain the JSON representation of [`project-metadata.toml`](#project-metadatatoml-toml)
